--[[
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘                      N E B U L A   U I   v1.0                      â•‘
    â•‘                   Cyber-Glass Design Language                      â•‘
    â•‘                                                                    â•‘
    â•‘  Author: Advanced Luau Developer                                   â•‘
    â•‘  Features: OOP Architecture, Spring Animations, Command Palette    â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
]]

--// æ ¸å¿ƒæœåŠ¡è·å–
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ContentProvider = game:GetService("ContentProvider")
local InsertService = game:GetService("InsertService")

--// æœ¬åœ°ç©å®¶å¼•ç”¨
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬ä¸€éƒ¨åˆ†: å·¥å…·æ¨¡å— (Utilities)
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Utilities = {}

--[[
    ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦
    ç”¨äºåˆ›å»ºä¸å¯é¢„æµ‹çš„ GUI åç§°ï¼Œé˜²æ­¢æ¸¸æˆæ£€æµ‹
]]
function Utilities.GenerateGUID()
    local template = "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx"
    return string.gsub(template, "[xy]", function(c)
        local v = (c == "x") and math.random(0, 15) or math.random(8, 11)
        return string.format("%x", v)
    end)
end

--[[
    åˆ›å»ºå¸¦æœ‰å¼¹æ€§åŠ¨ç”»çš„ Tween
    @param instance: è¦åŠ¨ç”»çš„å®ä¾‹
    @param properties: ç›®æ ‡å±æ€§è¡¨
    @param duration: æŒç»­æ—¶é—´ (é»˜è®¤ 0.4s)
    @param style: ç¼“åŠ¨é£æ ¼ (é»˜è®¤ Spring)
]]
function Utilities.SpringTween(instance, properties, duration, style)
    duration = duration or 0.4
    style = style or Enum.EasingStyle.Back
    
    local tweenInfo = TweenInfo.new(
        duration,
        style,
        Enum.EasingDirection.Out,
        0, false, 0
    )
    
    local tween = TweenService:Create(instance, tweenInfo, properties)
    tween:Play()
    return tween
end

--[[
    åˆ›å»ºä¸æ»‘çš„å¿«é€Ÿ Tween (ç”¨äºæ‚¬åœç­‰å³æ—¶åé¦ˆ)
]]
function Utilities.QuickTween(instance, properties, duration)
    duration = duration or 0.15
    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    local tween = TweenService:Create(instance, tweenInfo, properties)
    tween:Play()
    return tween
end

--[[
    æ·±åº¦å…‹éš†è¡¨ (ç”¨äºä¸»é¢˜é…ç½®)
]]
function Utilities.DeepClone(original)
    local clone = {}
    for k, v in pairs(original) do
        if type(v) == "table" then
            clone[k] = Utilities.DeepClone(v)
        else
            clone[k] = v
        end
    end
    return clone
end

--[[
    æ¨¡ç³Šæœç´¢ç®—æ³• (ç”¨äº Command Palette)
    åŸºäº Levenshtein è·ç¦»çš„å˜ä½“ï¼Œæ”¯æŒéƒ¨åˆ†åŒ¹é…
    @param query: æœç´¢è¯
    @param target: ç›®æ ‡å­—ç¬¦ä¸²
    @return: åŒ¹é…åˆ†æ•° (0-1, 1ä¸ºå®Œç¾åŒ¹é…)
]]
function Utilities.FuzzyMatch(query, target)
    query = string.lower(query)
    target = string.lower(target)
    
    -- å®Œå…¨åŒ¹é…
    if target == query then return 1 end
    
    -- åŒ…å«åŒ¹é… (æƒé‡è¾ƒé«˜)
    if string.find(target, query, 1, true) then
        return 0.8 + (0.2 * (#query / #target))
    end
    
    -- é¦–å­—æ¯åŒ¹é…
    local queryIndex = 1
    local score = 0
    local consecutiveBonus = 0
    
    for i = 1, #target do
        if queryIndex > #query then break end
        
        local queryChar = string.sub(query, queryIndex, queryIndex)
        local targetChar = string.sub(target, i, i)
        
        if queryChar == targetChar then
            score = score + 1 + consecutiveBonus
            consecutiveBonus = consecutiveBonus + 0.5  -- è¿ç»­åŒ¹é…åŠ åˆ†
            queryIndex = queryIndex + 1
        else
            consecutiveBonus = 0
        end
    end
    
    -- å½’ä¸€åŒ–åˆ†æ•°
    if queryIndex > #query then
        return (score / (#query + #target)) * 0.7
    end
    
    return 0
end

--[[
    åˆ›å»ºæ¶Ÿæ¼ªç‚¹å‡»æ•ˆæœ
    @param parent: æ¶Ÿæ¼ªæ•ˆæœçš„çˆ¶å®¹å™¨
    @param position: ç‚¹å‡»ä½ç½® (Vector2)
    @param color: æ¶Ÿæ¼ªé¢œè‰²
]]
function Utilities.CreateRipple(parent, position, color)
    local ripple = Instance.new("Frame")
    ripple.Name = "Ripple"
    ripple.BackgroundColor3 = color or Color3.fromRGB(255, 255, 255)
    ripple.BackgroundTransparency = 0.7
    ripple.BorderSizePixel = 0
    ripple.AnchorPoint = Vector2.new(0.5, 0.5)
    ripple.Position = UDim2.new(0, position.X, 0, position.Y)
    ripple.Size = UDim2.new(0, 0, 0, 0)
    ripple.ZIndex = 999
    ripple.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(1, 0)
    corner.Parent = ripple
    
    -- è®¡ç®—æ¶Ÿæ¼ªæœ€å¤§å°ºå¯¸
    local maxSize = math.max(parent.AbsoluteSize.X, parent.AbsoluteSize.Y) * 2.5
    
    -- æ‰©æ•£åŠ¨ç”»
    Utilities.SpringTween(ripple, {
        Size = UDim2.new(0, maxSize, 0, maxSize),
        BackgroundTransparency = 1
    }, 0.6, Enum.EasingStyle.Quad)
    
    -- æ¸…ç†
    task.delay(0.6, function()
        ripple:Destroy()
    end)
end

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬äºŒéƒ¨åˆ†: ä¸»é¢˜ç®¡ç†å™¨ (Theme Manager)
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local ThemeManager = {}
ThemeManager.__index = ThemeManager

--[[
    Cyber-Glass é»˜è®¤ä¸»é¢˜é…ç½®
    æ‰€æœ‰é¢œè‰²éƒ½ç»è¿‡ç²¾å¿ƒè°ƒé…ï¼Œç¡®ä¿è§†è§‰å’Œè°
]]
ThemeManager.Default = {
    -- ä¸»è‰²è°ƒ
    Primary = Color3.fromRGB(15, 15, 25),           -- æ·±é‚ƒèƒŒæ™¯
    Secondary = Color3.fromRGB(25, 25, 40),         -- æ¬¡çº§èƒŒæ™¯
    Tertiary = Color3.fromRGB(35, 35, 55),          -- ç¬¬ä¸‰å±‚èƒŒæ™¯
    
    -- å¼ºè°ƒè‰² (èµ›åšæœ‹å…‹é£æ ¼)
    Accent = Color3.fromRGB(88, 101, 242),          -- Discord è“ç´«è‰²
    AccentGlow = Color3.fromRGB(138, 151, 255),     -- å‘å…‰å¼ºè°ƒè‰²
    AccentSecondary = Color3.fromRGB(255, 92, 147), -- èµ›åšç²‰
    
    -- æ–‡æœ¬é¢œè‰²
    TextPrimary = Color3.fromRGB(255, 255, 255),
    TextSecondary = Color3.fromRGB(180, 180, 195),
    TextMuted = Color3.fromRGB(120, 120, 140),
    
    -- äº¤äº’çŠ¶æ€
    Hover = Color3.fromRGB(45, 45, 70),
    Active = Color3.fromRGB(55, 55, 85),
    Success = Color3.fromRGB(67, 181, 129),
    Error = Color3.fromRGB(237, 66, 69),
    Warning = Color3.fromRGB(250, 168, 26),
    
    -- è¾¹æ¡†ä¸åˆ†å‰²çº¿
    Border = Color3.fromRGB(50, 50, 75),
    Divider = Color3.fromRGB(40, 40, 60),
    
    -- é€æ˜åº¦é…ç½®
    BackgroundTransparency = 0.15,
    GlassTransparency = 0.4,
    
    -- åœ†è§’é…ç½®
    CornerRadius = UDim.new(0, 8),
    CornerRadiusSmall = UDim.new(0, 6),
    CornerRadiusLarge = UDim.new(0, 12),
    
    -- æµå…‰æ¸å˜é…ç½®
    GradientColors = {
        ColorSequence.new({
            ColorSequenceKeypoint.new(0, Color3.fromRGB(88, 101, 242)),
            ColorSequenceKeypoint.new(0.5, Color3.fromRGB(255, 92, 147)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(88, 101, 242))
        })
    },
    
    -- å­—ä½“
    Font = Enum.Font.GothamMedium,
    FontBold = Enum.Font.GothamBold,
    FontLight = Enum.Font.Gotham,
}

function ThemeManager.new(customTheme)
    local self = setmetatable({}, ThemeManager)
    self.Theme = Utilities.DeepClone(ThemeManager.Default)
    
    if customTheme then
        for key, value in pairs(customTheme) do
            self.Theme[key] = value
        end
    end
    
    return self
end

function ThemeManager:Get(property)
    return self.Theme[property]
end

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬ä¸‰éƒ¨åˆ†: æ‚¬æµ®èƒ¶å›Š (Floating Orb)
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local FloatingOrb = {}
FloatingOrb.__index = FloatingOrb

--[[
    åˆ›å»ºçµåŠ¨æ‚¬æµ®çƒ
    å½“ä¸»ç•Œé¢éšè—æ—¶ï¼Œæ˜¾ç¤ºä¸€ä¸ªå¯æ‹–åŠ¨çš„å‘¼å¸ç¯èƒ¶å›Š
]]
function FloatingOrb.new(theme, onExpand)
    local self = setmetatable({}, FloatingOrb)
    
    self.Theme = theme
    self.OnExpand = onExpand
    self.Visible = false
    self.Dragging = false
    self.LastClick = 0
    
    self:_CreateUI()
    self:_SetupAnimations()
    self:_SetupInteractions()
    
    return self
end

function FloatingOrb:_CreateUI()
    -- ä¸»èƒ¶å›Šå®¹å™¨
    self.Container = Instance.new("Frame")
    self.Container.Name = "NebulaOrb"
    self.Container.Size = UDim2.new(0, 50, 0, 50)
    self.Container.Position = UDim2.new(1, -70, 0.5, -25)
    self.Container.BackgroundColor3 = self.Theme:Get("Secondary")
    self.Container.BackgroundTransparency = 0.2
    self.Container.BorderSizePixel = 0
    self.Container.Visible = false
    self.Container.ZIndex = 9999
    
    -- åœ†å½¢å¤–è§‚
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(1, 0)
    corner.Parent = self.Container
    
    -- å‘å…‰è¾¹æ¡†
    self.GlowStroke = Instance.new("UIStroke")
    self.GlowStroke.Thickness = 2
    self.GlowStroke.Color = self.Theme:Get("Accent")
    self.GlowStroke.Transparency = 0.3
    self.GlowStroke.Parent = self.Container
    
    -- å†…éƒ¨å›¾æ ‡ (æ˜Ÿäº‘ç¬¦å·)
    self.Icon = Instance.new("TextLabel")
    self.Icon.Name = "Icon"
    self.Icon.Size = UDim2.new(1, 0, 1, 0)
    self.Icon.BackgroundTransparency = 1
    self.Icon.Text = "âœ¦"
    self.Icon.TextColor3 = self.Theme:Get("TextPrimary")
    self.Icon.TextSize = 24
    self.Icon.Font = Enum.Font.GothamBold
    self.Icon.Parent = self.Container
    
    -- å‘¼å¸å…‰ç¯
    self.BreathRing = Instance.new("Frame")
    self.BreathRing.Name = "BreathRing"
    self.BreathRing.Size = UDim2.new(1.4, 0, 1.4, 0)
    self.BreathRing.Position = UDim2.new(0.5, 0, 0.5, 0)
    self.BreathRing.AnchorPoint = Vector2.new(0.5, 0.5)
    self.BreathRing.BackgroundTransparency = 1
    self.BreathRing.BorderSizePixel = 0
    self.BreathRing.ZIndex = self.Container.ZIndex - 1
    self.BreathRing.Parent = self.Container
    
    local ringCorner = Instance.new("UICorner")
    ringCorner.CornerRadius = UDim.new(1, 0)
    ringCorner.Parent = self.BreathRing
    
    local ringStroke = Instance.new("UIStroke")
    ringStroke.Thickness = 1.5
    ringStroke.Color = self.Theme:Get("Accent")
    ringStroke.Transparency = 0.7
    ringStroke.Parent = self.BreathRing
    self.RingStroke = ringStroke
end

--[[
    è®¾ç½®å‘¼å¸ç¯åŠ¨ç”»
    ä½¿ç”¨ RunService å®ç°å¹³æ»‘çš„è„‰å†²æ•ˆæœ
]]
function FloatingOrb:_SetupAnimations()
    local breathPhase = 0
    
    self.AnimationConnection = RunService.Heartbeat:Connect(function(dt)
        if not self.Visible then return end
        
        breathPhase = breathPhase + dt * 2
        
        -- å‘¼å¸æ•ˆæœ: é€æ˜åº¦å’Œå°ºå¯¸å‘¨æœŸå˜åŒ–
        local breathValue = (math.sin(breathPhase) + 1) / 2
        
        self.GlowStroke.Transparency = 0.3 + breathValue * 0.4
        self.RingStroke.Transparency = 0.5 + breathValue * 0.4
        
        -- å…‰ç¯å°ºå¯¸è„‰åŠ¨
        local scale = 1.3 + breathValue * 0.2
        self.BreathRing.Size = UDim2.new(scale, 0, scale, 0)
    end)
end

function FloatingOrb:_SetupInteractions()
    local dragStart, startPos
    
    self.Container.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            
            -- åŒå‡»æ£€æµ‹
            local now = tick()
            if now - self.LastClick < 0.3 then
                -- åŒå‡»å±•å¼€
                if self.OnExpand then
                    self.OnExpand()
                end
                self.LastClick = 0
            else
                self.LastClick = now
                -- å¼€å§‹æ‹–åŠ¨
                self.Dragging = true
                dragStart = input.Position
                startPos = self.Container.Position
            end
        end
    end)
    
    self.Container.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            self.Dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if self.Dragging and 
           (input.UserInputType == Enum.UserInputType.MouseMovement or
            input.UserInputType == Enum.UserInputType.Touch) then
            
            local delta = input.Position - dragStart
            self.Container.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    -- æ‚¬åœæ•ˆæœ
    self.Container.MouseEnter:Connect(function()
        Utilities.QuickTween(self.Container, {
            Size = UDim2.new(0, 55, 0, 55),
            BackgroundTransparency = 0.1
        })
    end)
    
    self.Container.MouseLeave:Connect(function()
        Utilities.QuickTween(self.Container, {
            Size = UDim2.new(0, 50, 0, 50),
            BackgroundTransparency = 0.2
        })
    end)
end

function FloatingOrb:Show()
    self.Visible = true
    self.Container.Visible = true
    self.Container.Size = UDim2.new(0, 0, 0, 0)
    
    Utilities.SpringTween(self.Container, {
        Size = UDim2.new(0, 50, 0, 50)
    }, 0.5)
end

function FloatingOrb:Hide()
    self.Visible = false
    Utilities.SpringTween(self.Container, {
        Size = UDim2.new(0, 0, 0, 0)
    }, 0.3)
    
    task.delay(0.3, function()
        self.Container.Visible = false
    end)
end

function FloatingOrb:SetParent(parent)
    self.Container.Parent = parent
end

function FloatingOrb:Destroy()
    if self.AnimationConnection then
        self.AnimationConnection:Disconnect()
    end
    self.Container:Destroy()
end

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬å››éƒ¨åˆ†: å‘½ä»¤ä¸­æ¢ (Command Palette)
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local CommandPalette = {}
CommandPalette.__index = CommandPalette

--[[
    ç±»ä¼¼ Spotlight çš„å…¨å±€æœç´¢åŠŸèƒ½
    æ³¨å†Œæ‰€æœ‰ UI å…ƒç´ ï¼Œæ”¯æŒæ¨¡ç³Šæœç´¢å¿«é€Ÿè®¿é—®
]]
function CommandPalette.new(theme, parent)
    local self = setmetatable({}, CommandPalette)
    
    self.Theme = theme
    self.Parent = parent
    self.IsOpen = false
    self.Commands = {}  -- {name: string, callback: function, category: string}
    self.FilteredCommands = {}
    self.SelectedIndex = 1
    
    self:_CreateUI()
    self:_SetupInput()
    
    return self
end

function CommandPalette:_CreateUI()
    -- èƒŒæ™¯é®ç½©
    self.Overlay = Instance.new("Frame")
    self.Overlay.Name = "CommandOverlay"
    self.Overlay.Size = UDim2.new(1, 0, 1, 0)
    self.Overlay.BackgroundColor3 = Color3.new(0, 0, 0)
    self.Overlay.BackgroundTransparency = 1
    self.Overlay.BorderSizePixel = 0
    self.Overlay.Visible = false
    self.Overlay.ZIndex = 10000
    self.Overlay.Parent = self.Parent
    
    -- ä¸»æœç´¢é¢æ¿
    self.Panel = Instance.new("Frame")
    self.Panel.Name = "CommandPanel"
    self.Panel.Size = UDim2.new(0, 500, 0, 60)
    self.Panel.Position = UDim2.new(0.5, 0, 0.3, 0)
    self.Panel.AnchorPoint = Vector2.new(0.5, 0)
    self.Panel.BackgroundColor3 = self.Theme:Get("Secondary")
    self.Panel.BackgroundTransparency = 0.1
    self.Panel.BorderSizePixel = 0
    self.Panel.Parent = self.Overlay
    
    local panelCorner = Instance.new("UICorner")
    panelCorner.CornerRadius = self.Theme:Get("CornerRadiusLarge")
    panelCorner.Parent = self.Panel
    
    -- æ¯›ç»ç’ƒè¾¹æ¡†æ•ˆæœ
    local panelStroke = Instance.new("UIStroke")
    panelStroke.Thickness = 1
    panelStroke.Color = self.Theme:Get("Border")
    panelStroke.Transparency = 0.5
    panelStroke.Parent = self.Panel
    
    -- æœç´¢å›¾æ ‡
    local searchIcon = Instance.new("TextLabel")
    searchIcon.Name = "SearchIcon"
    searchIcon.Size = UDim2.new(0, 40, 1, 0)
    searchIcon.Position = UDim2.new(0, 10, 0, 0)
    searchIcon.BackgroundTransparency = 1
    searchIcon.Text = "ğŸ”"
    searchIcon.TextSize = 20
    searchIcon.Font = Enum.Font.GothamMedium
    searchIcon.TextColor3 = self.Theme:Get("TextMuted")
    searchIcon.Parent = self.Panel
    
    -- æœç´¢è¾“å…¥æ¡†
    self.SearchBox = Instance.new("TextBox")
    self.SearchBox.Name = "SearchBox"
    self.SearchBox.Size = UDim2.new(1, -60, 1, 0)
    self.SearchBox.Position = UDim2.new(0, 50, 0, 0)
    self.SearchBox.BackgroundTransparency = 1
    self.SearchBox.Text = ""
    self.SearchBox.PlaceholderText = "Search commands... (Ctrl+K)"
    self.SearchBox.PlaceholderColor3 = self.Theme:Get("TextMuted")
    self.SearchBox.TextColor3 = self.Theme:Get("TextPrimary")
    self.SearchBox.TextSize = 16
    self.SearchBox.Font = self.Theme:Get("Font")
    self.SearchBox.TextXAlignment = Enum.TextXAlignment.Left
    self.SearchBox.ClearTextOnFocus = false
    self.SearchBox.Parent = self.Panel
    
    -- ç»“æœåˆ—è¡¨å®¹å™¨
    self.ResultsContainer = Instance.new("ScrollingFrame")
    self.ResultsContainer.Name = "Results"
    self.ResultsContainer.Size = UDim2.new(1, 0, 0, 0)  -- åˆå§‹é«˜åº¦ä¸º0
    self.ResultsContainer.Position = UDim2.new(0, 0, 1, 5)
    self.ResultsContainer.BackgroundColor3 = self.Theme:Get("Secondary")
    self.ResultsContainer.BackgroundTransparency = 0.1
    self.ResultsContainer.BorderSizePixel = 0
    self.ResultsContainer.ScrollBarThickness = 4
    self.ResultsContainer.ScrollBarImageColor3 = self.Theme:Get("Accent")
    self.ResultsContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    self.ResultsContainer.Parent = self.Panel
    
    local resultsCorner = Instance.new("UICorner")
    resultsCorner.CornerRadius = self.Theme:Get("CornerRadius")
    resultsCorner.Parent = self.ResultsContainer
    
    local resultsLayout = Instance.new("UIListLayout")
    resultsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    resultsLayout.Padding = UDim.new(0, 2)
    resultsLayout.Parent = self.ResultsContainer
    
    local resultsPadding = Instance.new("UIPadding")
    resultsPadding.PaddingAll = UDim.new(0, 5)
    resultsPadding.Parent = self.ResultsContainer
end

function CommandPalette:_SetupInput()
    -- æœç´¢æ¡†æ–‡æœ¬å˜åŒ–ç›‘å¬
    self.SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
        self:_FilterCommands(self.SearchBox.Text)
    end)
    
    -- é”®ç›˜å¯¼èˆª
    self.SearchBox.FocusLost:Connect(function(enterPressed)
        if enterPressed and #self.FilteredCommands > 0 then
            self:_ExecuteSelected()
        end
    end)
    
    -- å…³é—­é®ç½©ç‚¹å‡»
    self.Overlay.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            self:Close()
        end
    end)
end

--[[
    æ¨¡ç³Šæœç´¢è¿‡æ»¤å‘½ä»¤
    æ ¹æ®è¾“å…¥è¯è¿‡æ»¤å¹¶æ’åºå‘½ä»¤åˆ—è¡¨
]]
function CommandPalette:_FilterCommands(query)
    -- æ¸…ç©ºç°æœ‰ç»“æœ
    for _, child in ipairs(self.ResultsContainer:GetChildren()) do
        if child:IsA("Frame") then
            child:Destroy()
        end
    end
    
    if query == "" then
        self.FilteredCommands = {}
        self:_UpdateResultsHeight()
        return
    end
    
    -- è®¡ç®—åŒ¹é…åˆ†æ•°å¹¶æ’åº
    local scored = {}
    for _, cmd in ipairs(self.Commands) do
        local score = Utilities.FuzzyMatch(query, cmd.name)
        if score > 0.1 then
            table.insert(scored, {command = cmd, score = score})
        end
    end
    
    table.sort(scored, function(a, b) return a.score > b.score end)
    
    -- å–å‰10ä¸ªç»“æœ
    self.FilteredCommands = {}
    for i = 1, math.min(#scored, 10) do
        table.insert(self.FilteredCommands, scored[i].command)
        self:_CreateResultItem(scored[i].command, i)
    end
    
    self.SelectedIndex = 1
    self:_HighlightSelected()
    self:_UpdateResultsHeight()
end

function CommandPalette:_CreateResultItem(command, index)
    local item = Instance.new("Frame")
    item.Name = "Result_" .. index
    item.Size = UDim2.new(1, -10, 0, 40)
    item.BackgroundColor3 = self.Theme:Get("Tertiary")
    item.BackgroundTransparency = 0.5
    item.BorderSizePixel = 0
    item.LayoutOrder = index
    item.Parent = self.ResultsContainer
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = self.Theme:Get("CornerRadiusSmall")
    corner.Parent = item
    
    -- å‘½ä»¤åç§°
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "Name"
    nameLabel.Size = UDim2.new(1, -80, 0, 20)
    nameLabel.Position = UDim2.new(0, 12, 0, 5)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = command.name
    nameLabel.TextColor3 = self.Theme:Get("TextPrimary")
    nameLabel.TextSize = 14
    nameLabel.Font = self.Theme:Get("FontBold")
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.Parent = item
    
    -- åˆ†ç±»æ ‡ç­¾
    local categoryLabel = Instance.new("TextLabel")
    categoryLabel.Name = "Category"
    categoryLabel.Size = UDim2.new(1, -80, 0, 15)
    categoryLabel.Position = UDim2.new(0, 12, 0, 23)
    categoryLabel.BackgroundTransparency = 1
    categoryLabel.Text = command.category or "General"
    categoryLabel.TextColor3 = self.Theme:Get("TextMuted")
    categoryLabel.TextSize = 11
    categoryLabel.Font = self.Theme:Get("FontLight")
    categoryLabel.TextXAlignment = Enum.TextXAlignment.Left
    categoryLabel.Parent = item
    
    -- å¿«æ·é”®æç¤º
    local shortcut = Instance.new("TextLabel")
    shortcut.Name = "Shortcut"
    shortcut.Size = UDim2.new(0, 60, 0, 24)
    shortcut.Position = UDim2.new(1, -70, 0.5, -12)
    shortcut.BackgroundColor3 = self.Theme:Get("Primary")
    shortcut.BackgroundTransparency = 0.3
    shortcut.Text = "â†µ"
    shortcut.TextColor3 = self.Theme:Get("TextMuted")
    shortcut.TextSize = 12
    shortcut.Font = self.Theme:Get("Font")
    shortcut.Parent = item
    
    local shortcutCorner = Instance.new("UICorner")
    shortcutCorner.CornerRadius = UDim.new(0, 4)
    shortcutCorner.Parent = shortcut
    
    -- ç‚¹å‡»æ‰§è¡Œ
    item.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            self.SelectedIndex = index
            self:_ExecuteSelected()
        end
    end)
    
    -- æ‚¬åœæ•ˆæœ
    item.MouseEnter:Connect(function()
        self.SelectedIndex = index
        self:_HighlightSelected()
    end)
end

function CommandPalette:_HighlightSelected()
    for i, child in ipairs(self.ResultsContainer:GetChildren()) do
        if child:IsA("Frame") then
            local isSelected = child.LayoutOrder == self.SelectedIndex
            Utilities.QuickTween(child, {
                BackgroundTransparency = isSelected and 0.2 or 0.5,
                BackgroundColor3 = isSelected and 
                    self.Theme:Get("Accent") or 
                    self.Theme:Get("Tertiary")
            })
        end
    end
end

function CommandPalette:_UpdateResultsHeight()
    local count = #self.FilteredCommands
    local height = count * 42 + 10  -- 40px per item + padding
    height = math.min(height, 250)  -- æœ€å¤§é«˜åº¦
    
    Utilities.QuickTween(self.ResultsContainer, {
        Size = UDim2.new(1, 0, 0, count > 0 and height or 0)
    }, 0.2)
    
    self.ResultsContainer.CanvasSize = UDim2.new(0, 0, 0, count * 42)
end

function CommandPalette:_ExecuteSelected()
    if self.FilteredCommands[self.SelectedIndex] then
        local cmd = self.FilteredCommands[self.SelectedIndex]
        self:Close()
        
        if cmd.callback then
            cmd.callback()
        end
    end
end

--[[
    æ³¨å†Œå‘½ä»¤åˆ°æœç´¢ç³»ç»Ÿ
    @param name: å‘½ä»¤åç§° (ç”¨äºæœç´¢)
    @param callback: æ‰§è¡Œå›è°ƒ
    @param category: åˆ†ç±»æ ‡ç­¾
]]
function CommandPalette:RegisterCommand(name, callback, category)
    table.insert(self.Commands, {
        name = name,
        callback = callback,
        category = category or "General"
    })
end

function CommandPalette:Open()
    self.IsOpen = true
    self.Overlay.Visible = true
    self.SearchBox.Text = ""
    
    -- åŠ¨ç”»: é®ç½©æ·¡å…¥
    Utilities.QuickTween(self.Overlay, {BackgroundTransparency = 0.6}, 0.2)
    
    -- åŠ¨ç”»: é¢æ¿å¼¹å…¥
    self.Panel.Position = UDim2.new(0.5, 0, 0.25, 0)
    self.Panel.Size = UDim2.new(0, 480, 0, 50)
    
    Utilities.SpringTween(self.Panel, {
        Position = UDim2.new(0.5, 0, 0.3, 0),
        Size = UDim2.new(0, 500, 0, 60)
    }, 0.4)
    
    -- èšç„¦æœç´¢æ¡†
    task.delay(0.1, function()
        self.SearchBox:CaptureFocus()
    end)
end

function CommandPalette:Close()
    self.IsOpen = false
    
    Utilities.QuickTween(self.Overlay, {BackgroundTransparency = 1}, 0.15)
    Utilities.QuickTween(self.Panel, {
        Position = UDim2.new(0.5, 0, 0.25, 0),
        Size = UDim2.new(0, 480, 0, 50)
    }, 0.15)
    
    task.delay(0.15, function()
        self.Overlay.Visible = false
    end)
end

function CommandPalette:Toggle()
    if self.IsOpen then
        self:Close()
    else
        self:Open()
    end
end

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬äº”éƒ¨åˆ†: UI ç»„ä»¶ç±» (Components)
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

--// ================== Button æŒ‰é’®ç»„ä»¶ ==================
local Button = {}
Button.__index = Button

function Button.new(parent, config, theme, commandPalette)
    local self = setmetatable({}, Button)
    
    self.Parent = parent
    self.Config = config
    self.Theme = theme
    self.CommandPalette = commandPalette
    self.Callback = config.Callback or function() end
    
    self:_Create()
    
    -- æ³¨å†Œåˆ°å‘½ä»¤ä¸­æ¢
    if commandPalette then
        commandPalette:RegisterCommand(
            config.Name or "Button",
            function() self.Callback() end,
            config.Category or "Actions"
        )
    end
    
    return self
end

function Button:_Create()
    self.Container = Instance.new("Frame")
    self.Container.Name = self.Config.Name or "Button"
    self.Container.Size = UDim2.new(1, -20, 0, 36)
    self.Container.BackgroundColor3 = self.Theme:Get("Tertiary")
    self.Container.BackgroundTransparency = 0.3
    self.Container.BorderSizePixel = 0
    self.Container.Parent = self.Parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = self.Theme:Get("CornerRadius")
    corner.Parent = self.Container
    
    -- æŒ‰é’®æ ‡é¢˜
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -20, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = self.Config.Name or "Button"
    title.TextColor3 = self.Theme:Get("TextPrimary")
    title.TextSize = 14
    title.Font = self.Theme:Get("Font")
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = self.Container
    
    -- å›¾æ ‡ (å¦‚æœæä¾›)
    if self.Config.Icon then
        local icon = Instance.new("ImageLabel")
        icon.Name = "Icon"
        icon.Size = UDim2.new(0, 18, 0, 18)
        icon.Position = UDim2.new(1, -28, 0.5, -9)
        icon.BackgroundTransparency = 1
        icon.Image = self.Config.Icon
        icon.ImageColor3 = self.Theme:Get("TextSecondary")
        icon.Parent = self.Container
    end
    
    -- äº¤äº’
    self.Container.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            -- æ¶Ÿæ¼ªæ•ˆæœ
            local pos = input.Position
            local relativePos = Vector2.new(
                pos.X - self.Container.AbsolutePosition.X,
                pos.Y - self.Container.AbsolutePosition.Y
            )
            Utilities.CreateRipple(self.Container, relativePos, self.Theme:Get("Accent"))
            
            -- ç‚¹å‡»åŠ¨ç”»
            Utilities.QuickTween(self.Container, {
                BackgroundTransparency = 0.1
            }, 0.1)
            
            self.Callback()
        end
    end)
    
    self.Container.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            Utilities.QuickTween(self.Container, {
                BackgroundTransparency = 0.3
            }, 0.2)
        end
    end)
    
    -- æ‚¬åœ
    self.Container.MouseEnter:Connect(function()
        Utilities.QuickTween(self.Container, {
            BackgroundColor3 = self.Theme:Get("Hover")
        })
    end)
    
    self.Container.MouseLeave:Connect(function()
        Utilities.QuickTween(self.Container, {
            BackgroundColor3 = self.Theme:Get("Tertiary")
        })
    end)
end

--// ================== Toggle å¼€å…³ç»„ä»¶ ==================
local Toggle = {}
Toggle.__index = Toggle

function Toggle.new(parent, config, theme, commandPalette)
    local self = setmetatable({}, Toggle)
    
    self.Parent = parent
    self.Config = config
    self.Theme = theme
    self.CommandPalette = commandPalette
    self.State = config.Default or false
    self.Callback = config.Callback or function() end
    
    self:_Create()
    
    -- æ³¨å†Œåˆ°å‘½ä»¤ä¸­æ¢
    if commandPalette then
        commandPalette:RegisterCommand(
            (config.Name or "Toggle") .. " (Toggle)",
            function() self:SetState(not self.State) end,
            config.Category or "Toggles"
        )
    end
    
    return self
end

function Toggle:_Create()
    self.Container = Instance.new("Frame")
    self.Container.Name = self.Config.Name or "Toggle"
    self.Container.Size = UDim2.new(1, -20, 0, 36)
    self.Container.BackgroundColor3 = self.Theme:Get("Tertiary")
    self.Container.BackgroundTransparency = 0.3
    self.Container.BorderSizePixel = 0
    self.Container.Parent = self.Parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = self.Theme:Get("CornerRadius")
    corner.Parent = self.Container
    
    -- æ ‡é¢˜
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -70, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = self.Config.Name or "Toggle"
    title.TextColor3 = self.Theme:Get("TextPrimary")
    title.TextSize = 14
    title.Font = self.Theme:Get("Font")
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = self.Container
    
    -- å¼€å…³è½¨é“
    self.Track = Instance.new("Frame")
    self.Track.Name = "Track"
    self.Track.Size = UDim2.new(0, 44, 0, 22)
    self.Track.Position = UDim2.new(1, -54, 0.5, -11)
    self.Track.BackgroundColor3 = self.Theme:Get("Primary")
    self.Track.BorderSizePixel = 0
    self.Track.Parent = self.Container
    
    local trackCorner = Instance.new("UICorner")
    trackCorner.CornerRadius = UDim.new(1, 0)
    trackCorner.Parent = self.Track
    
    self.TrackStroke = Instance.new("UIStroke")
    self.TrackStroke.Thickness = 1.5
    self.TrackStroke.Color = self.Theme:Get("Border")
    self.TrackStroke.Parent = self.Track
    
    -- å¼€å…³åœ†çƒ
    self.Knob = Instance.new("Frame")
    self.Knob.Name = "Knob"
    self.Knob.Size = UDim2.new(0, 18, 0, 18)
    self.Knob.Position = UDim2.new(0, 2, 0.5, -9)
    self.Knob.BackgroundColor3 = self.Theme:Get("TextSecondary")
    self.Knob.BorderSizePixel = 0
    self.Knob.Parent = self.Track
    
    local knobCorner = Instance.new("UICorner")
    knobCorner.CornerRadius = UDim.new(1, 0)
    knobCorner.Parent = self.Knob
    
    -- æ›´æ–°è§†è§‰çŠ¶æ€
    self:_UpdateVisual(false)
    
    -- äº¤äº’
    self.Container.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            self:SetState(not self.State)
        end
    end)
    
    -- æ‚¬åœ
    self.Container.MouseEnter:Connect(function()
        Utilities.QuickTween(self.Container, {
            BackgroundColor3 = self.Theme:Get("Hover")
        })
    end)
    
    self.Container.MouseLeave:Connect(function()
        Utilities.QuickTween(self.Container, {
            BackgroundColor3 = self.Theme:Get("Tertiary")
        })
    end)
end

--[[
    æ›´æ–°å¼€å…³è§†è§‰çŠ¶æ€
    ä½¿ç”¨ Spring åŠ¨ç”»å®ç°ä¸æ»‘è¿‡æ¸¡
]]
function Toggle:_UpdateVisual(animate)
    local targetKnobPos = self.State and UDim2.new(1, -20, 0.5, -9) or UDim2.new(0, 2, 0.5, -9)
    local targetTrackColor = self.State and self.Theme:Get("Accent") or self.Theme:Get("Primary")
    local targetKnobColor = self.State and self.Theme:Get("TextPrimary") or self.Theme:Get("TextSecondary")
    local targetStrokeColor = self.State and self.Theme:Get("AccentGlow") or self.Theme:Get("Border")
    
    if animate then
        Utilities.SpringTween(self.Knob, {Position = targetKnobPos}, 0.4)
        Utilities.QuickTween(self.Track, {BackgroundColor3 = targetTrackColor}, 0.2)
        Utilities.QuickTween(self.Knob, {BackgroundColor3 = targetKnobColor}, 0.2)
        Utilities.QuickTween(self.TrackStroke, {Color = targetStrokeColor}, 0.2)
    else
        self.Knob.Position = targetKnobPos
        self.Track.BackgroundColor3 = targetTrackColor
        self.Knob.BackgroundColor3 = targetKnobColor
        self.TrackStroke.Color = targetStrokeColor
    end
end

function Toggle:SetState(state)
    self.State = state
    self:_UpdateVisual(true)
    self.Callback(state)
end

function Toggle:GetState()
    return self.State
end

--// ================== Slider æ»‘æ¡ç»„ä»¶ ==================
local Slider = {}
Slider.__index = Slider

function Slider.new(parent, config, theme, commandPalette)
    local self = setmetatable({}, Slider)
    
    self.Parent = parent
    self.Config = config
    self.Theme = theme
    self.CommandPalette = commandPalette
    
    self.Min = config.Min or 0
    self.Max = config.Max or 100
    self.Value = config.Default or self.Min
    self.Increment = config.Increment or 1
    self.Callback = config.Callback or function() end
    self.Dragging = false
    
    self:_Create()
    
    return self
end

function Slider:_Create()
    self.Container = Instance.new("Frame")
    self.Container.Name = self.Config.Name or "Slider"
    self.Container.Size = UDim2.new(1, -20, 0, 50)
    self.Container.BackgroundColor3 = self.Theme:Get("Tertiary")
    self.Container.BackgroundTransparency = 0.3
    self.Container.BorderSizePixel = 0
    self.Container.Parent = self.Parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = self.Theme:Get("CornerRadius")
    corner.Parent = self.Container
    
    -- æ ‡é¢˜è¡Œ
    local titleRow = Instance.new("Frame")
    titleRow.Name = "TitleRow"
    titleRow.Size = UDim2.new(1, -20, 0, 20)
    titleRow.Position = UDim2.new(0, 10, 0, 6)
    titleRow.BackgroundTransparency = 1
    titleRow.Parent = self.Container
    
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(0.7, 0, 1, 0)
    title.BackgroundTransparency = 1
    title.Text = self.Config.Name or "Slider"
    title.TextColor3 = self.Theme:Get("TextPrimary")
    title.TextSize = 13
    title.Font = self.Theme:Get("Font")
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = titleRow
    
    -- æ•°å€¼æ˜¾ç¤º
    self.ValueLabel = Instance.new("TextLabel")
    self.ValueLabel.Name = "Value"
    self.ValueLabel.Size = UDim2.new(0.3, 0, 1, 0)
    self.ValueLabel.Position = UDim2.new(0.7, 0, 0, 0)
    self.ValueLabel.BackgroundTransparency = 1
    self.ValueLabel.Text = tostring(self.Value)
    self.ValueLabel.TextColor3 = self.Theme:Get("Accent")
    self.ValueLabel.TextSize = 13
    self.ValueLabel.Font = self.Theme:Get("FontBold")
    self.ValueLabel.TextXAlignment = Enum.TextXAlignment.Right
    self.ValueLabel.Parent = titleRow
    
    -- æ»‘è½¨èƒŒæ™¯
    self.TrackBg = Instance.new("Frame")
    self.TrackBg.Name = "TrackBg"
    self.TrackBg.Size = UDim2.new(1, -20, 0, 6)
    self.TrackBg.Position = UDim2.new(0, 10, 0, 34)
    self.TrackBg.BackgroundColor3 = self.Theme:Get("Primary")
    self.TrackBg.BorderSizePixel = 0
    self.TrackBg.Parent = self.Container
    
    local trackCorner = Instance.new("UICorner")
    trackCorner.CornerRadius = UDim.new(1, 0)
    trackCorner.Parent = self.TrackBg
    
    -- æ»‘è½¨å¡«å…… (å½“å‰è¿›åº¦)
    self.TrackFill = Instance.new("Frame")
    self.TrackFill.Name = "TrackFill"
    self.TrackFill.Size = UDim2.new(0, 0, 1, 0)
    self.TrackFill.BackgroundColor3 = self.Theme:Get("Accent")
    self.TrackFill.BorderSizePixel = 0
    self.TrackFill.Parent = self.TrackBg
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(1, 0)
    fillCorner.Parent = self.TrackFill
    
    -- æ¸å˜æ•ˆæœ
    local fillGradient = Instance.new("UIGradient")
    fillGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, self.Theme:Get("Accent")),
        ColorSequenceKeypoint.new(1, self.Theme:Get("AccentGlow"))
    })
    fillGradient.Parent = self.TrackFill
    
    -- æ»‘å—æ‰‹æŸ„
    self.Knob = Instance.new("Frame")
    self.Knob.Name = "Knob"
    self.Knob.Size = UDim2.new(0, 16, 0, 16)
    self.Knob.AnchorPoint = Vector2.new(0.5, 0.5)
    self.Knob.Position = UDim2.new(0, 0, 0.5, 0)
    self.Knob.BackgroundColor3 = self.Theme:Get("TextPrimary")
    self.Knob.BorderSizePixel = 0
    self.Knob.ZIndex = 2
    self.Knob.Parent = self.TrackBg
    
    local knobCorner = Instance.new("UICorner")
    knobCorner.CornerRadius = UDim.new(1, 0)
    knobCorner.Parent = self.Knob
    
    -- æ‰‹æŸ„é˜´å½±
    local knobStroke = Instance.new("UIStroke")
    knobStroke.Thickness = 2
    knobStroke.Color = self.Theme:Get("Accent")
    knobStroke.Transparency = 0.5
    knobStroke.Parent = self.Knob
    
    -- åˆå§‹åŒ–è§†è§‰
    self:_UpdateVisual(false)
    
    -- æ‹–æ‹½äº¤äº’
    self.TrackBg.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            self.Dragging = true
            self:_UpdateFromInput(input.Position.X)
        end
    end)
    
    self.TrackBg.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            self.Dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if self.Dragging and
           (input.UserInputType == Enum.UserInputType.MouseMovement or
            input.UserInputType == Enum.UserInputType.Touch) then
            self:_UpdateFromInput(input.Position.X)
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            self.Dragging = false
        end
    end)
    
    -- æ‚¬åœæ•ˆæœ
    self.Container.MouseEnter:Connect(function()
        Utilities.QuickTween(self.Container, {
            BackgroundColor3 = self.Theme:Get("Hover")
        })
    end)
    
    self.Container.MouseLeave:Connect(function()
        Utilities.QuickTween(self.Container, {
            BackgroundColor3 = self.Theme:Get("Tertiary")
        })
    end)
end

--[[
    ä»é¼ æ ‡Xåæ ‡è®¡ç®—å¹¶æ›´æ–°æ»‘æ¡å€¼
    åŒ…å«æ­¥è¿›å€¼ï¼ˆIncrementï¼‰çš„é‡åŒ–å¤„ç†
    
    @param mouseX: é¼ æ ‡çš„å±å¹•Xåæ ‡
]]
function Slider:_UpdateFromInput(mouseX)
    local trackAbsPos = self.TrackBg.AbsolutePosition.X
    local trackAbsSize = self.TrackBg.AbsoluteSize.X
    
    -- è®¡ç®—ç›¸å¯¹ä½ç½® (0-1)
    local relativeX = math.clamp((mouseX - trackAbsPos) / trackAbsSize, 0, 1)
    
    -- å°†ç›¸å¯¹ä½ç½®æ˜ å°„åˆ° Min-Max èŒƒå›´
    local rawValue = self.Min + (relativeX * (self.Max - self.Min))
    
    -- åº”ç”¨æ­¥è¿›é‡åŒ–
    -- ä¾‹å¦‚: Increment=5, rawValue=17 â†’ é‡åŒ–å=15
    local steps = math.round((rawValue - self.Min) / self.Increment)
    local quantizedValue = self.Min + (steps * self.Increment)
    
    -- ç¡®ä¿åœ¨èŒƒå›´å†…
    quantizedValue = math.clamp(quantizedValue, self.Min, self.Max)
    
    if quantizedValue ~= self.Value then
        self.Value = quantizedValue
        self:_UpdateVisual(true)
        self.Callback(self.Value)
    end
end

function Slider:_UpdateVisual(animate)
    local ratio = (self.Value - self.Min) / (self.Max - self.Min)
    local targetFillSize = UDim2.new(ratio, 0, 1, 0)
    local targetKnobPos = UDim2.new(ratio, 0, 0.5, 0)
    
    self.ValueLabel.Text = tostring(self.Value)
    
    if animate then
        Utilities.SpringTween(self.TrackFill, {Size = targetFillSize}, 0.3)
        Utilities.SpringTween(self.Knob, {Position = targetKnobPos}, 0.3)
    else
        self.TrackFill.Size = targetFillSize
        self.Knob.Position = targetKnobPos
    end
end

function Slider:SetValue(value)
    self.Value = math.clamp(value, self.Min, self.Max)
    self:_UpdateVisual(true)
    self.Callback(self.Value)
end

function Slider:GetValue()
    return self.Value
end

--// ================== Dropdown ä¸‹æ‹‰èœå•ç»„ä»¶ ==================
local Dropdown = {}
Dropdown.__index = Dropdown

function Dropdown.new(parent, config, theme, commandPalette)
    local self = setmetatable({}, Dropdown)
    
    self.Parent = parent
    self.Config = config
    self.Theme = theme
    self.CommandPalette = commandPalette
    self.Options = config.Options or {}
    self.Selected = config.Default or (self.Options[1] or "")
    self.Callback = config.Callback or function() end
    self.IsOpen = false
    self.FilteredOptions = self.Options
    
    self:_Create()
    
    return self
end

function Dropdown:_Create()
    self.Container = Instance.new("Frame")
    self.Container.Name = self.Config.Name or "Dropdown"
    self.Container.Size = UDim2.new(1, -20, 0, 36)
    self.Container.BackgroundColor3 = self.Theme:Get("Tertiary")
    self.Container.BackgroundTransparency = 0.3
    self.Container.BorderSizePixel = 0
    self.Container.ClipsDescendants = false
    self.Container.Parent = self.Parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = self.Theme:Get("CornerRadius")
    corner.Parent = self.Container
    
    -- æ ‡é¢˜
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(0.4, 0, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = self.Config.Name or "Dropdown"
    title.TextColor3 = self.Theme:Get("TextPrimary")
    title.TextSize = 14
    title.Font = self.Theme:Get("Font")
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = self.Container
    
    -- å½“å‰é€‰æ‹©æŒ‰é’®
    self.SelectButton = Instance.new("TextButton")
    self.SelectButton.Name = "SelectButton"
    self.SelectButton.Size = UDim2.new(0.55, -10, 0, 28)
    self.SelectButton.Position = UDim2.new(0.45, 0, 0.5, -14)
    self.SelectButton.BackgroundColor3 = self.Theme:Get("Primary")
    self.SelectButton.BorderSizePixel = 0
    self.SelectButton.Text = self.Selected
    self.SelectButton.TextColor3 = self.Theme:Get("TextSecondary")
    self.SelectButton.TextSize = 12
    self.SelectButton.Font = self.Theme:Get("Font")
    self.SelectButton.TextTruncate = Enum.TextTruncate.AtEnd
    self.SelectButton.Parent = self.Container
    
    local selectCorner = Instance.new("UICorner")
    selectCorner.CornerRadius = self.Theme:Get("CornerRadiusSmall")
    selectCorner.Parent = self.SelectButton
    
    -- ä¸‹æ‹‰ç®­å¤´
    local arrow = Instance.new("TextLabel")
    arrow.Name = "Arrow"
    arrow.Size = UDim2.new(0, 20, 1, 0)
    arrow.Position = UDim2.new(1, -22, 0, 0)
    arrow.BackgroundTransparency = 1
    arrow.Text = "â–¼"
    arrow.TextColor3 = self.Theme:Get("TextMuted")
    arrow.TextSize = 10
    arrow.Parent = self.SelectButton
    self.Arrow = arrow
    
    -- ä¸‹æ‹‰é¢æ¿
    self.DropPanel = Instance.new("Frame")
    self.DropPanel.Name = "DropPanel"
    self.DropPanel.Size = UDim2.new(0.55, -10, 0, 0)
    self.DropPanel.Position = UDim2.new(0.45, 0, 1, 5)
    self.DropPanel.BackgroundColor3 = self.Theme:Get("Secondary")
    self.DropPanel.BackgroundTransparency = 0.05
    self.DropPanel.BorderSizePixel = 0
    self.DropPanel.ClipsDescendants = true
    self.DropPanel.Visible = false
    self.DropPanel.ZIndex = 100
    self.DropPanel.Parent = self.Container
    
    local panelCorner = Instance.new("UICorner")
    panelCorner.CornerRadius = self.Theme:Get("CornerRadius")
    panelCorner.Parent = self.DropPanel
    
    local panelStroke = Instance.new("UIStroke")
    panelStroke.Thickness = 1
    panelStroke.Color = self.Theme:Get("Border")
    panelStroke.Parent = self.DropPanel
    
    -- æœç´¢æ¡†
    self.SearchBox = Instance.new("TextBox")
    self.SearchBox.Name = "Search"
    self.SearchBox.Size = UDim2.new(1, -10, 0, 28)
    self.SearchBox.Position = UDim2.new(0, 5, 0, 5)
    self.SearchBox.BackgroundColor3 = self.Theme:Get("Primary")
    self.SearchBox.BorderSizePixel = 0
    self.SearchBox.Text = ""
    self.SearchBox.PlaceholderText = "ğŸ” Search..."
    self.SearchBox.PlaceholderColor3 = self.Theme:Get("TextMuted")
    self.SearchBox.TextColor3 = self.Theme:Get("TextPrimary")
    self.SearchBox.TextSize = 12
    self.SearchBox.Font = self.Theme:Get("Font")
    self.SearchBox.ClearTextOnFocus = false
    self.SearchBox.ZIndex = 101
    self.SearchBox.Parent = self.DropPanel
    
    local searchCorner = Instance.new("UICorner")
    searchCorner.CornerRadius = self.Theme:Get("CornerRadiusSmall")
    searchCorner.Parent = self.SearchBox
    
    -- é€‰é¡¹åˆ—è¡¨
    self.OptionsList = Instance.new("ScrollingFrame")
    self.OptionsList.Name = "Options"
    self.OptionsList.Size = UDim2.new(1, -10, 1, -40)
    self.OptionsList.Position = UDim2.new(0, 5, 0, 38)
    self.OptionsList.BackgroundTransparency = 1
    self.OptionsList.BorderSizePixel = 0
    self.OptionsList.ScrollBarThickness = 3
    self.OptionsList.ScrollBarImageColor3 = self.Theme:Get("Accent")
    self.OptionsList.CanvasSize = UDim2.new(0, 0, 0, 0)
    self.OptionsList.ZIndex = 101
    self.OptionsList.Parent = self.DropPanel
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.SortOrder = Enum.SortOrder.LayoutOrder
    listLayout.Padding = UDim.new(0, 2)
    listLayout.Parent = self.OptionsList
    
    -- å¡«å……é€‰é¡¹
    self:_PopulateOptions()
    
    -- äº¤äº’
    self.SelectButton.MouseButton1Click:Connect(function()
        self:Toggle()
    end)
    
    self.SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
        self:_FilterOptions(self.SearchBox.Text)
    end)
    
    -- æ‚¬åœ
    self.Container.MouseEnter:Connect(function()
        Utilities.QuickTween(self.Container, {
            BackgroundColor3 = self.Theme:Get("Hover")
        })
    end)
    
    self.Container.MouseLeave:Connect(function()
        if not self.IsOpen then
            Utilities.QuickTween(self.Container, {
                BackgroundColor3 = self.Theme:Get("Tertiary")
            })
        end
    end)
end

function Dropdown:_PopulateOptions()
    -- æ¸…ç©ºç°æœ‰é€‰é¡¹
    for _, child in ipairs(self.OptionsList:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    
    for i, option in ipairs(self.FilteredOptions) do
        local optBtn = Instance.new("TextButton")
        optBtn.Name = "Option_" .. i
        optBtn.Size = UDim2.new(1, 0, 0, 28)
        optBtn.BackgroundColor3 = self.Theme:Get("Tertiary")
        optBtn.BackgroundTransparency = 0.5
        optBtn.BorderSizePixel = 0
        optBtn.Text = option
        optBtn.TextColor3 = (option == self.Selected) and 
            self.Theme:Get("Accent") or 
            self.Theme:Get("TextSecondary")
        optBtn.TextSize = 12
        optBtn.Font = self.Theme:Get("Font")
        optBtn.LayoutOrder = i
        optBtn.ZIndex = 102
        optBtn.Parent = self.OptionsList
        
        local optCorner = Instance.new("UICorner")
        optCorner.CornerRadius = self.Theme:Get("CornerRadiusSmall")
        optCorner.Parent = optBtn
        
        optBtn.MouseButton1Click:Connect(function()
            self:Select(option)
        end)
        
        optBtn.MouseEnter:Connect(function()
            Utilities.QuickTween(optBtn, {
                BackgroundTransparency = 0.2,
                BackgroundColor3 = self.Theme:Get("Accent")
            })
        end)
        
        optBtn.MouseLeave:Connect(function()
            Utilities.QuickTween(optBtn, {
                BackgroundTransparency = 0.5,
                BackgroundColor3 = self.Theme:Get("Tertiary")
            })
        end)
    end
    
    self.OptionsList.CanvasSize = UDim2.new(0, 0, 0, #self.FilteredOptions * 30)
end

function Dropdown:_FilterOptions(query)
    if query == "" then
        self.FilteredOptions = self.Options
    else
        self.FilteredOptions = {}
        for _, option in ipairs(self.Options) do
            if Utilities.FuzzyMatch(query, option) > 0.2 then
                table.insert(self.FilteredOptions, option)
            end
        end
    end
    self:_PopulateOptions()
end

function Dropdown:Toggle()
    self.IsOpen = not self.IsOpen
    
    if self.IsOpen then
        self.DropPanel.Visible = true
        self.SearchBox.Text = ""
        self.FilteredOptions = self.Options
        self:_PopulateOptions()
        
        local panelHeight = math.min(#self.Options * 30 + 45, 180)
        
        Utilities.SpringTween(self.DropPanel, {
            Size = UDim2.new(0.55, -10, 0, panelHeight)
        }, 0.3)
        
        Utilities.QuickTween(self.Arrow, {Rotation = 180}, 0.2)
    else
        Utilities.SpringTween(self.DropPanel, {
            Size = UDim2.new(0.55, -10, 0, 0)
        }, 0.2)
        
        Utilities.QuickTween(self.Arrow, {Rotation = 0}, 0.2)
        
        task.delay(0.2, function()
            self.DropPanel.Visible = false
        end)
    end
end

function Dropdown:Select(option)
    self.Selected = option
    self.SelectButton.Text = option
    self:Toggle()
    self.Callback(option)
end

function Dropdown:SetOptions(options)
    self.Options = options
    self.FilteredOptions = options
    self:_PopulateOptions()
end

--// ================== Viewport3D 3Dé¢„è§ˆç»„ä»¶ ==================
local Viewport3D = {}
Viewport3D.__index = Viewport3D

function Viewport3D.new(parent, config, theme)
    local self = setmetatable({}, Viewport3D)
    
    self.Parent = parent
    self.Config = config
    self.Theme = theme
    self.Model = nil
    self.RotationSpeed = config.RotationSpeed or 30
    self.CurrentRotation = 0
    
    self:_Create()
    
    if config.ModelId then
        self:LoadModel(config.ModelId)
    end
    
    return self
end

function Viewport3D:_Create()
    self.Container = Instance.new("Frame")
    self.Container.Name = self.Config.Name or "Viewport3D"
    self.Container.Size = UDim2.new(1, -20, 0, 150)
    self.Container.BackgroundColor3 = self.Theme:Get("Primary")
    self.Container.BackgroundTransparency = 0.2
    self.Container.BorderSizePixel = 0
    self.Container.Parent = self.Parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = self.Theme:Get("CornerRadius")
    corner.Parent = self.Container
    
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 1
    stroke.Color = self.Theme:Get("Border")
    stroke.Parent = self.Container
    
    -- æ ‡é¢˜
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -20, 0, 25)
    title.Position = UDim2.new(0, 10, 0, 5)
    title.BackgroundTransparency = 1
    title.Text = self.Config.Name or "3D Preview"
    title.TextColor3 = self.Theme:Get("TextPrimary")
    title.TextSize = 13
    title.Font = self.Theme:Get("FontBold")
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = self.Container
    
    -- ViewportFrame
    self.Viewport = Instance.new("ViewportFrame")
    self.Viewport.Name = "Viewport"
    self.Viewport.Size = UDim2.new(1, -20, 1, -40)
    self.Viewport.Position = UDim2.new(0, 10, 0, 30)
    self.Viewport.BackgroundColor3 = self.Theme:Get("Secondary")
    self.Viewport.BackgroundTransparency = 0.5
    self.Viewport.BorderSizePixel = 0
    self.Viewport.Parent = self.Container
    
    local vpCorner = Instance.new("UICorner")
    vpCorner.CornerRadius = self.Theme:Get("CornerRadiusSmall")
    vpCorner.Parent = self.Viewport
    
    -- ç›¸æœº
    self.Camera = Instance.new("Camera")
    self.Camera.FieldOfView = 50
    self.Viewport.CurrentCamera = self.Camera
    
    -- åŠ è½½æç¤º
    self.LoadingLabel = Instance.new("TextLabel")
    self.LoadingLabel.Name = "Loading"
    self.LoadingLabel.Size = UDim2.new(1, 0, 1, 0)
    self.LoadingLabel.BackgroundTransparency = 1
    self.LoadingLabel.Text = "Loading..."
    self.LoadingLabel.TextColor3 = self.Theme:Get("TextMuted")
    self.LoadingLabel.TextSize = 14
    self.LoadingLabel.Font = self.Theme:Get("Font")
    self.LoadingLabel.Parent = self.Viewport
    
    -- æ—‹è½¬åŠ¨ç”»
    self.RotationConnection = RunService.Heartbeat:Connect(function(dt)
        if self.Model and self.Model.PrimaryPart then
            self.CurrentRotation = self.CurrentRotation + (self.RotationSpeed * dt)
            self:_UpdateCamera()
        end
    end)
end

--[[
    åŠ è½½å¹¶æ˜¾ç¤º3Dæ¨¡å‹
    @param modelId: èµ„äº§ID (rbxassetid æ ¼å¼æˆ–æ•°å­—ID)
]]
function Viewport3D:LoadModel(modelId)
    self.LoadingLabel.Visible = true
    
    task.spawn(function()
        local success, result = pcall(function()
            -- å¦‚æœæ˜¯æ•°å­—IDï¼Œè½¬æ¢ä¸ºèµ„äº§æ ¼å¼
            if type(modelId) == "number" then
                modelId = "rbxassetid://" .. modelId
            end
            
            -- å°è¯•ä»èµ„äº§æœåŠ¡è·å–æ¨¡å‹
            local model = InsertService:LoadAsset(modelId)
            return model:GetChildren()[1]
        end)
        
        if success and result then
            self:SetModel(result)
        else
            self.LoadingLabel.Text = "Failed to load"
            warn("[Nebula] Failed to load model:", result)
        end
    end)
end

function Viewport3D:SetModel(model)
    -- æ¸…é™¤æ—§æ¨¡å‹
    for _, child in ipairs(self.Viewport:GetChildren()) do
        if child:IsA("Model") or child:IsA("BasePart") then
            child:Destroy()
        end
    end
    
    self.Model = model:Clone()
    self.Model.Parent = self.Viewport
    
    -- ç¡®ä¿æœ‰ PrimaryPart
    if not self.Model.PrimaryPart then
        for _, part in ipairs(self.Model:GetDescendants()) do
            if part:IsA("BasePart") then
                self.Model.PrimaryPart = part
                break
            end
        end
    end
    
    -- è®¡ç®—æ¨¡å‹è¾¹ç•Œä»¥è°ƒæ•´ç›¸æœº
    self:_UpdateCamera()
    self.LoadingLabel.Visible = false
end

function Viewport3D:_UpdateCamera()
    if not self.Model or not self.Model.PrimaryPart then return end
    
    -- è·å–æ¨¡å‹è¾¹ç•Œ
    local cf, size = self.Model:GetBoundingBox()
    local maxDim = math.max(size.X, size.Y, size.Z)
    
    -- è®¡ç®—ç›¸æœºä½ç½® (å›´ç»•æ¨¡å‹æ—‹è½¬)
    local distance = maxDim * 2
    local radians = math.rad(self.CurrentRotation)
    
    local cameraPos = cf.Position + Vector3.new(
        math.sin(radians) * distance,
        distance * 0.5,
        math.cos(radians) * distance
    )
    
    self.Camera.CFrame = CFrame.new(cameraPos, cf.Position)
end

function Viewport3D:Destroy()
    if self.RotationConnection then
        self.RotationConnection:Disconnect()
    end
    self.Container:Destroy()
end

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬å…­éƒ¨åˆ†: Tab æ ‡ç­¾é¡µç±»
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Tab = {}
Tab.__index = Tab

function Tab.new(parent, tabButton, config, theme, commandPalette)
    local self = setmetatable({}, Tab)
    
    self.Parent = parent
    self.TabButton = tabButton
    self.Config = config
    self.Theme = theme
    self.CommandPalette = commandPalette
    self.Components = {}
    self.Visible = false
    
    self:_Create()
    
    return self
end

function Tab:_Create()
    -- æ ‡ç­¾é¡µå†…å®¹å®¹å™¨
    self.Container = Instance.new("ScrollingFrame")
    self.Container.Name = self.Config.Name or "Tab"
    self.Container.Size = UDim2.new(1, 0, 1, 0)
    self.Container.BackgroundTransparency = 1
    self.Container.BorderSizePixel = 0
    self.Container.ScrollBarThickness = 4
    self.Container.ScrollBarImageColor3 = self.Theme:Get("Accent")
    self.Container.CanvasSize = UDim2.new(0, 0, 0, 0)
    self.Container.Visible = false
    self.Container.Parent = self.Parent
    
    -- å†…å®¹å¸ƒå±€
    self.Layout = Instance.new("UIListLayout")
    self.Layout.SortOrder = Enum.SortOrder.LayoutOrder
    self.Layout.Padding = UDim.new(0, 8)
    self.Layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    self.Layout.Parent = self.Container
    
    -- å†…è¾¹è·
    local padding = Instance.new("UIPadding")
    padding.PaddingTop = UDim.new(0, 10)
    padding.PaddingBottom = UDim.new(0, 10)
    padding.PaddingLeft = UDim.new(0, 10)
    padding.PaddingRight = UDim.new(0, 10)
    padding.Parent = self.Container
    
    -- åŠ¨æ€æ›´æ–°ç”»å¸ƒå¤§å°
    self.Layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        self.Container.CanvasSize = UDim2.new(0, 0, 0, self.Layout.AbsoluteContentSize.Y + 20)
    end)
end

function Tab:Show()
    self.Visible = true
    self.Container.Visible = true
    self.Container.GroupTransparency = 1
    
    Utilities.QuickTween(self.Container, {GroupTransparency = 0}, 0.2)
end

function Tab:Hide()
    self.Visible = false
    Utilities.QuickTween(self.Container, {GroupTransparency = 1}, 0.15)
    
    task.delay(0.15, function()
        if not self.Visible then
            self.Container.Visible = false
        end
    end)
end

-- æ·»åŠ æŒ‰é’®
function Tab:AddButton(config)
    local button = Button.new(self.Container, config, self.Theme, self.CommandPalette)
    table.insert(self.Components, button)
    return button
end

-- æ·»åŠ å¼€å…³
function Tab:AddToggle(config)
    local toggle = Toggle.new(self.Container, config, self.Theme, self.CommandPalette)
    table.insert(self.Components, toggle)
    return toggle
end

-- æ·»åŠ æ»‘æ¡
function Tab:AddSlider(config)
    local slider = Slider.new(self.Container, config, self.Theme, self.CommandPalette)
    table.insert(self.Components, slider)
    return slider
end

-- æ·»åŠ ä¸‹æ‹‰èœå•
function Tab:AddDropdown(config)
    local dropdown = Dropdown.new(self.Container, config, self.Theme, self.CommandPalette)
    table.insert(self.Components, dropdown)
    return dropdown
end

-- æ·»åŠ 3Dé¢„è§ˆ
function Tab:Add3DPreview(config)
    local viewport = Viewport3D.new(self.Container, config, self.Theme)
    table.insert(self.Components, viewport)
    return viewport
end

-- æ·»åŠ åˆ†éš”çº¿
function Tab:AddDivider()
    local divider = Instance.new("Frame")
    divider.Name = "Divider"
    divider.Size = UDim2.new(0.9, 0, 0, 1)
    divider.BackgroundColor3 = self.Theme:Get("Divider")
    divider.BackgroundTransparency = 0.5
    divider.BorderSizePixel = 0
    divider.Parent = self.Container
    
    return divider
end

-- æ·»åŠ æ ‡é¢˜æ–‡æœ¬
function Tab:AddLabel(text)
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.new(1, -20, 0, 25)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = self.Theme:Get("TextMuted")
    label.TextSize = 12
    label.Font = self.Theme:Get("FontBold")
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = self.Container
    
    return label
end

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬ä¸ƒéƒ¨åˆ†: Window çª—å£ç±»
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Window = {}
Window.__index = Window

function Window.new(config, library)
    local self = setmetatable({}, Window)
    
    self.Library = library
    self.Config = config
    self.Theme = ThemeManager.new(config.Theme)
    self.Tabs = {}
    self.CurrentTab = nil
    self.Visible = true
    self.Minimized = false
    
    self:_CreateUI()
    self:_SetupDragging()
    self:_SetupKeyBinds()
    
    -- åˆ›å»ºæ‚¬æµ®çƒ
    self.FloatingOrb = FloatingOrb.new(self.Theme, function()
        self:Expand()
    end)
    self.FloatingOrb:SetParent(self.ScreenGui)
    
    -- åˆ›å»ºå‘½ä»¤ä¸­æ¢
    self.CommandPalette = CommandPalette.new(self.Theme, self.ScreenGui)
    
    return self
end

function Window:_CreateUI()
    -- ä¸» ScreenGui
    self.ScreenGui = Instance.new("ScreenGui")
    self.ScreenGui.Name = "Nebula_" .. Utilities.GenerateGUID()
    self.ScreenGui.ResetOnSpawn = false
    self.ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    self.ScreenGui.IgnoreGuiInset = true
    
    -- å°è¯•æ”¾å…¥ CoreGui (æ›´å®‰å…¨)
    local success = pcall(function()
        self.ScreenGui.Parent = game:GetService("CoreGui")
    end)
    
    if not success then
        self.ScreenGui.Parent = PlayerGui
    end
    
    -- ä¸»çª—å£å®¹å™¨
    self.MainFrame = Instance.new("Frame")
    self.MainFrame.Name = "MainWindow"
    self.MainFrame.Size = UDim2.new(0, self.Config.Size and self.Config.Size.X or 550, 0, self.Config.Size and self.Config.Size.Y or 380)
    self.MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    self.MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    self.MainFrame.BackgroundColor3 = self.Theme:Get("Primary")
    self.MainFrame.BackgroundTransparency = self.Theme:Get("BackgroundTransparency")
    self.MainFrame.BorderSizePixel = 0
    self.MainFrame.ClipsDescendants = true
    self.MainFrame.Parent = self.ScreenGui
    
    -- åœ†è§’
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = self.Theme:Get("CornerRadiusLarge")
    mainCorner.Parent = self.MainFrame
    
    -- è¾¹æ¡†æè¾¹
    local mainStroke = Instance.new("UIStroke")
    mainStroke.Thickness = 1.5
    mainStroke.Color = self.Theme:Get("Border")
    mainStroke.Transparency = 0.3
    mainStroke.Parent = self.MainFrame
    
    -- å‘å…‰è¾¹æ¡†æ¸å˜ (åŠ¨æ€æµå…‰æ•ˆæœ)
    self.GlowGradient = Instance.new("UIGradient")
    self.GlowGradient.Color = self.Theme:Get("GradientColors")[1]
    self.GlowGradient.Rotation = 0
    self.GlowGradient.Parent = mainStroke
    
    -- æµå…‰åŠ¨ç”»
    task.spawn(function()
        while self.ScreenGui and self.ScreenGui.Parent do
            for i = 0, 360, 2 do
                if not self.ScreenGui or not self.ScreenGui.Parent then break end
                self.GlowGradient.Rotation = i
                task.wait(0.03)
            end
        end
    end)
    
    -- ============ é¡¶éƒ¨æ  ============
    self.TopBar = Instance.new("Frame")
    self.TopBar.Name = "TopBar"
    self.TopBar.Size = UDim2.new(1, 0, 0, 50)
    self.TopBar.BackgroundColor3 = self.Theme:Get("Secondary")
    self.TopBar.BackgroundTransparency = 0.3
    self.TopBar.BorderSizePixel = 0
    self.TopBar.Parent = self.MainFrame
    
    -- æ ‡é¢˜
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.Size = UDim2.new(0, 200, 1, 0)
    titleLabel.Position = UDim2.new(0, 15, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = self.Config.Title or "Nebula UI"
    titleLabel.TextColor3 = self.Theme:Get("TextPrimary")
    titleLabel.TextSize = 18
    titleLabel.Font = self.Theme:Get("FontBold")
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = self.TopBar
    
    -- å‰¯æ ‡é¢˜/ç‰ˆæœ¬
    if self.Config.Subtitle then
        local subtitleLabel = Instance.new("TextLabel")
        subtitleLabel.Name = "Subtitle"
        subtitleLabel.Size = UDim2.new(0, 100, 0, 15)
        subtitleLabel.Position = UDim2.new(0, 15, 0, 32)
        subtitleLabel.BackgroundTransparency = 1
        subtitleLabel.Text = self.Config.Subtitle
        subtitleLabel.TextColor3 = self.Theme:Get("TextMuted")
        subtitleLabel.TextSize = 11
        subtitleLabel.Font = self.Theme:Get("FontLight")
        subtitleLabel.TextXAlignment = Enum.TextXAlignment.Left
        subtitleLabel.Parent = self.TopBar
        
        titleLabel.Size = UDim2.new(0, 200, 0, 25)
        titleLabel.Position = UDim2.new(0, 15, 0, 5)
    end
    
    -- æ§åˆ¶æŒ‰é’®å®¹å™¨
    local controlsFrame = Instance.new("Frame")
    controlsFrame.Name = "Controls"
    controlsFrame.Size = UDim2.new(0, 100, 0, 30)
    controlsFrame.Position = UDim2.new(1, -110, 0.5, -15)
    controlsFrame.BackgroundTransparency = 1
    controlsFrame.Parent = self.TopBar
    
    local controlsLayout = Instance.new("UIListLayout")
    controlsLayout.FillDirection = Enum.FillDirection.Horizontal
    controlsLayout.HorizontalAlignment = Enum.HorizontalAlignment.Right
    controlsLayout.VerticalAlignment = Enum.VerticalAlignment.Center
    controlsLayout.Padding = UDim.new(0, 8)
    controlsLayout.Parent = controlsFrame
    
    -- æœç´¢æŒ‰é’® (æ‰“å¼€å‘½ä»¤ä¸­æ¢)
    local searchBtn = self:_CreateControlButton("ğŸ”", controlsFrame, function()
        self.CommandPalette:Toggle()
    end)
    
    -- æœ€å°åŒ–æŒ‰é’®
    local minimizeBtn = self:_CreateControlButton("â”€", controlsFrame, function()
        self:Minimize()
    end)
    
    -- å…³é—­æŒ‰é’®
    local closeBtn = self:_CreateControlButton("âœ•", controlsFrame, function()
        self:Destroy()
    end)
    closeBtn.TextColor3 = self.Theme:Get("Error")
    
    -- ============ ä¾§è¾¹æ ‡ç­¾æ  ============
    self.SideBar = Instance.new("Frame")
    self.SideBar.Name = "SideBar"
    self.SideBar.Size = UDim2.new(0, 140, 1, -50)
    self.SideBar.Position = UDim2.new(0, 0, 0, 50)
    self.SideBar.BackgroundColor3 = self.Theme:Get("Secondary")
    self.SideBar.BackgroundTransparency = 0.5
    self.SideBar.BorderSizePixel = 0
    self.SideBar.Parent = self.MainFrame
    
    -- æ ‡ç­¾æŒ‰é’®å®¹å™¨
    self.TabButtonContainer = Instance.new("ScrollingFrame")
    self.TabButtonContainer.Name = "TabButtons"
    self.TabButtonContainer.Size = UDim2.new(1, -10, 1, -20)
    self.TabButtonContainer.Position = UDim2.new(0, 5, 0, 10)
    self.TabButtonContainer.BackgroundTransparency = 1
    self.TabButtonContainer.BorderSizePixel = 0
    self.TabButtonContainer.ScrollBarThickness = 2
    self.TabButtonContainer.ScrollBarImageColor3 = self.Theme:Get("Accent")
    self.TabButtonContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
    self.TabButtonContainer.Parent = self.SideBar
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 5)
    tabLayout.Parent = self.TabButtonContainer
    
    tabLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        self.TabButtonContainer.CanvasSize = UDim2.new(0, 0, 0, tabLayout.AbsoluteContentSize.Y)
    end)
    
    -- ============ å†…å®¹åŒºåŸŸ ============
    self.ContentArea = Instance.new("Frame")
    self.ContentArea.Name = "ContentArea"
    self.ContentArea.Size = UDim2.new(1, -145, 1, -55)
    self.ContentArea.Position = UDim2.new(0, 145, 0, 55)
    self.ContentArea.BackgroundTransparency = 1
    self.ContentArea.BorderSizePixel = 0
    self.ContentArea.ClipsDescendants = true
    self.ContentArea.Parent = self.MainFrame
end

function Window:_CreateControlButton(text, parent, callback)
    local btn = Instance.new("TextButton")
    btn.Name = "ControlBtn"
    btn.Size = UDim2.new(0, 28, 0, 28)
    btn.BackgroundColor3 = self.Theme:Get("Tertiary")
    btn.BackgroundTransparency = 0.5
    btn.BorderSizePixel = 0
    btn.Text = text
    btn.TextColor3 = self.Theme:Get("TextSecondary")
    btn.TextSize = 14
    btn.Font = Enum.Font.GothamBold
    btn.Parent = parent
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = self.Theme:Get("CornerRadiusSmall")
    corner.Parent = btn
    
    btn.MouseButton1Click:Connect(callback)
    
    btn.MouseEnter:Connect(function()
        Utilities.QuickTween(btn, {
            BackgroundTransparency = 0.2,
            Size = UDim2.new(0, 30, 0, 30)
        })
    end)
    
    btn.MouseLeave:Connect(function()
        Utilities.QuickTween(btn, {
            BackgroundTransparency = 0.5,
            Size = UDim2.new(0, 28, 0, 28)
        })
    end)
    
    return btn
end

function Window:_SetupDragging()
    local dragging, dragStart, startPos
    
    self.TopBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = self.MainFrame.Position
        end
    end)
    
    self.TopBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and
           (input.UserInputType == Enum.UserInputType.MouseMovement or
            input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            self.MainFrame.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
end

function Window:_SetupKeyBinds()
    UserInputService.InputBegan:Connect(function(input, processed)
        if processed then return end
        
        -- å³Ctrl: æœ€å°åŒ–/å±•å¼€åˆ‡æ¢
        if input.KeyCode == Enum.KeyCode.RightControl then
            if self.Minimized then
                self:Expand()
            else
                self:Minimize()
            end
        end
        
        -- Ctrl+K: æ‰“å¼€å‘½ä»¤ä¸­æ¢
        if input.KeyCode == Enum.KeyCode.K then
            if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) or
               UserInputService:IsKeyDown(Enum.KeyCode.RightControl) then
                self.CommandPalette:Toggle()
            end
        end
    end)
end

--[[
    åˆ›å»ºæ–°æ ‡ç­¾é¡µ
    @param config: {Name: string, Icon: string?}
    @return: Tab å®ä¾‹
]]
function Window:CreateTab(config)
    local tabIndex = #self.Tabs + 1
    
    -- åˆ›å»ºæ ‡ç­¾æŒ‰é’®
    local tabButton = Instance.new("TextButton")
    tabButton.Name = "Tab_" .. (config.Name or tabIndex)
    tabButton.Size = UDim2.new(1, -10, 0, 36)
    tabButton.BackgroundColor3 = self.Theme:Get("Tertiary")
    tabButton.BackgroundTransparency = 0.5
    tabButton.BorderSizePixel = 0
    tabButton.Text = ""
    tabButton.LayoutOrder = tabIndex
    tabButton.Parent = self.TabButtonContainer
    
    local btnCorner = Instance.new("UICorner")
    btnCorner.CornerRadius = self.Theme:Get("CornerRadius")
    btnCorner.Parent = tabButton
    
    -- é€‰ä¸­æŒ‡ç¤ºå™¨
    local indicator = Instance.new("Frame")
    indicator.Name = "Indicator"
    indicator.Size = UDim2.new(0, 3, 0.6, 0)
    indicator.Position = UDim2.new(0, 0, 0.2, 0)
    indicator.BackgroundColor3 = self.Theme:Get("Accent")
    indicator.BackgroundTransparency = 1
    indicator.BorderSizePixel = 0
    indicator.Parent = tabButton
    
    local indCorner = Instance.new("UICorner")
    indCorner.CornerRadius = UDim.new(0, 2)
    indCorner.Parent = indicator
    
    -- å›¾æ ‡ (å¦‚æœæœ‰)
    local contentStart = 12
    if config.Icon then
        local icon = Instance.new("ImageLabel")
        icon.Name = "Icon"
        icon.Size = UDim2.new(0, 18, 0, 18)
        icon.Position = UDim2.new(0, 10, 0.5, -9)
        icon.BackgroundTransparency = 1
        icon.Image = config.Icon
        icon.ImageColor3 = self.Theme:Get("TextSecondary")
        icon.Parent = tabButton
        contentStart = 35
    end
    
    -- æ ‡ç­¾åç§°
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "Name"
    nameLabel.Size = UDim2.new(1, -contentStart - 10, 1, 0)
    nameLabel.Position = UDim2.new(0, contentStart, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = config.Name or "Tab"
    nameLabel.TextColor3 = self.Theme:Get("TextSecondary")
    nameLabel.TextSize = 13
    nameLabel.Font = self.Theme:Get("Font")
    nameLabel.TextXAlignment = Enum.TextXAlignment.Left
    nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
    nameLabel.Parent = tabButton
    
    -- åˆ›å»º Tab å®ä¾‹
    local tab = Tab.new(self.ContentArea, tabButton, config, self.Theme, self.CommandPalette)
    tab.Indicator = indicator
    tab.NameLabel = nameLabel
    table.insert(self.Tabs, tab)
    
    -- ç‚¹å‡»åˆ‡æ¢
    tabButton.MouseButton1Click:Connect(function()
        self:SelectTab(tab)
    end)
    
    -- æ‚¬åœæ•ˆæœ
    tabButton.MouseEnter:Connect(function()
        if self.CurrentTab ~= tab then
            Utilities.QuickTween(tabButton, {BackgroundTransparency = 0.3})
        end
    end)
    
    tabButton.MouseLeave:Connect(function()
        if self.CurrentTab ~= tab then
            Utilities.QuickTween(tabButton, {BackgroundTransparency = 0.5})
        end
    end)
    
    -- è‡ªåŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªæ ‡ç­¾
    if #self.Tabs == 1 then
        self:SelectTab(tab)
    end
    
    return tab
end

function Window:SelectTab(tab)
    -- å–æ¶ˆé€‰ä¸­å½“å‰æ ‡ç­¾
    if self.CurrentTab then
        self.CurrentTab:Hide()
        Utilities.QuickTween(self.CurrentTab.TabButton, {
            BackgroundTransparency = 0.5
        })
        Utilities.QuickTween(self.CurrentTab.Indicator, {
            BackgroundTransparency = 1
        })
        Utilities.QuickTween(self.CurrentTab.NameLabel, {
            TextColor3 = self.Theme:Get("TextSecondary")
        })
    end
    
    -- é€‰ä¸­æ–°æ ‡ç­¾
    self.CurrentTab = tab
    tab:Show()
    
    Utilities.QuickTween(tab.TabButton, {
        BackgroundTransparency = 0.2,
        BackgroundColor3 = self.Theme:Get("Accent")
    }, 0.25)
    
    Utilities.SpringTween(tab.Indicator, {
        BackgroundTransparency = 0
    }, 0.3)
    
    Utilities.QuickTween(tab.NameLabel, {
        TextColor3 = self.Theme:Get("TextPrimary")
    })
end

function Window:Minimize()
    self.Minimized = true
    
    -- ç¼©å°åŠ¨ç”»
    Utilities.SpringTween(self.MainFrame, {
        Size = UDim2.new(0, 0, 0, 0),
        BackgroundTransparency = 1
    }, 0.4)
    
    task.delay(0.3, function()
        self.MainFrame.Visible = false
        self.FloatingOrb:Show()
    end)
end

function Window:Expand()
    self.Minimized = false
    self.FloatingOrb:Hide()
    
    self.MainFrame.Visible = true
    self.MainFrame.Size = UDim2.new(0, 0, 0, 0)
    self.MainFrame.BackgroundTransparency = 1
    
    local targetSize = UDim2.new(0, self.Config.Size and self.Config.Size.X or 550, 0, self.Config.Size and self.Config.Size.Y or 380)
    
    Utilities.SpringTween(self.MainFrame, {
        Size = targetSize,
        BackgroundTransparency = self.Theme:Get("BackgroundTransparency")
    }, 0.5)
end

function Window:Toggle()
    if self.Minimized then
        self:Expand()
    else
        self:Minimize()
    end
end

function Window:Destroy()
    self.FloatingOrb:Destroy()
    self.ScreenGui:Destroy()
end

--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--// ç¬¬å…«éƒ¨åˆ†: ä¸»åº“å…¥å£ (Nebula Library)
--// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local Nebula = {}
Nebula.__index = Nebula
Nebula.Version = "1.0.0"
Nebula.Windows = {}

--[[
    åˆ›å»ºæ–°çª—å£
    @param config: {
        Title: string,
        Subtitle: string?,
        Size: Vector2?,
        Theme: table?  -- è‡ªå®šä¹‰ä¸»é¢˜è¦†ç›–
    }
    @return: Window å®ä¾‹
]]
function Nebula:CreateWindow(config)
    local window = Window.new(config, self)
    table.insert(self.Windows, window)
    return window
end

-- å…¨å±€ä¸»é¢˜é¢„è®¾
Nebula.Themes = {
    Default = ThemeManager.Default,
    
    -- ç´«è‰²éœ“è™¹ä¸»é¢˜
    Neon = {
        Accent = Color3.fromRGB(190, 100, 255),
        AccentGlow = Color3.fromRGB(220, 150, 255),
        Primary = Color3.fromRGB(10, 5, 20),
        Secondary = Color3.fromRGB(20, 10, 35),
    },
    
    -- æš—çº¢ä¸»é¢˜
    Blood = {
        Accent = Color3.fromRGB(200, 50, 70),
        AccentGlow = Color3.fromRGB(255, 100, 120),
        Primary = Color3.fromRGB(15, 8, 10),
        Secondary = Color3.fromRGB(30, 15, 20),
    },
    
    -- é’è‰²ç§‘æŠ€ä¸»é¢˜
    Cyber = {
        Accent = Color3.fromRGB(0, 255, 200),
        AccentGlow = Color3.fromRGB(100, 255, 220),
        Primary = Color3.fromRGB(5, 15, 15),
        Secondary = Color3.fromRGB(10, 25, 25),
    },
}

-- æ³¨å…¥å…¨å±€ç¯å¢ƒ
if getgenv then
    getgenv().Nebula = Nebula
    getgenv().NebulaUI = Nebula
end

return Nebula
